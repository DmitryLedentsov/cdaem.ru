jQuery(function(){$("#advertform-rent_type").find("input[type=checkbox]").on("click",function(){var e,r=$(this);r.prop("checked")?((e=$("#form-apartment").data("formApi")).reset("advertform-type-"+r.val()),e.reset("#advertform-price-"+r.val()),e.reset("#advertform-currency-"+r.val()),e.targetForm.find('[name ^= "AdvertForm[currency]"]').val(1).selectpicker("refresh"),$("#rent-type-"+r.val()).addClass("show")):$("#rent-type-"+r.val()).removeClass("show")}),$("#form-reservation").formApi({fields:["_csrf","ReservationForm[city_id]","ReservationForm[address]","ReservationForm[pets]","ReservationForm[children]","ReservationForm[clients_count]","ReservationForm[arrived_date]","ReservationForm[arrived_time]","ReservationForm[out_date]","ReservationForm[out_time]","ReservationForm[actuality_duration]","ReservationForm[rent_type]","ReservationForm[rooms]","ReservationForm[floor]","ReservationForm[beds]","ReservationForm[metro_walk]","ReservationForm[more_info]","ReservationForm[verifyCode]","ReservationForm[money_from]","ReservationForm[money_to]","ReservationForm[currency]","ReservationForm[email]","ReservationForm[phone]","ReservationForm[password]","ReservationForm[agreement]"],extraSubmitFields:{submit:"submit"},validateFields:["reservationform-city_id","reservationform-address","reservationform-pets","reservationform-children","reservationform-clients_count","reservationform-arrived_date","reservationform-arrived_time","reservationform-out_date","reservationform-out_time","reservationform-actuality_duration","reservationform-rent_type","reservationform-rooms","reservationform-floor","reservationform-beds","reservationform-metro_walk","reservationform-more_info","reservationform-verifycode","reservationform-budget","reservationform-email","reservationform-phone","reservationform-password","reservationform-agreement"],success:function(e,r){$.isPlainObject(r)&&"status"in r==0&&scrollToFirstError(r,e.validateFields)},complete:function(e,r,t){302!=r.status&&$("#reservationform-verifycode-image").length&&$("#reservationform-verifycode-image").yiiCaptcha("refresh")}}),$("#form-apartment").formApi({fields:["_csrf","AdvertForm[rent_type][]","AdvertForm[price]","AdvertForm[currency]","ApartmentForm[city]","ApartmentForm[visible]","ApartmentForm[city_id]","ApartmentForm[address]","ApartmentForm[metro_walk]","ApartmentForm[apartment]","ApartmentForm[floor]","ApartmentForm[total_area]","ApartmentForm[total_rooms]","ApartmentForm[beds]","ApartmentForm[remont]","ApartmentForm[description]","ApartmentForm[metro_array][]","ImageForm[files][]"],extraSubmitFields:{submit:"submit"},validateFields:["advertform-rent_type","advertform-type-*","apartmentform-city_id","apartmentform-address","apartmentform-visible","apartmentform-metro_walk","apartmentform-apartment","apartmentform-floor","apartmentform-total_area","apartmentform-total_rooms","apartmentform-beds","apartmentform-remont","apartmentform-description","apartmentform-metro_array","imageform-files"],success:function(e,r){$.isPlainObject(r)&&"status"in r&&(1==r.status?showStackInfo("Информация",r.message):showStackError("Ошибка",r.message)),$.isPlainObject(r)&&"status"in r==0&&scrollToFirstError(r,e.validateFields)}}),$("#imageform-files").bind("change",function(e){if(window.FileReader){var r=$("#form-apartment").data("formApi"),o=document.getElementById("imageform-files").files;if(10<=$("#images-preview .advert-preview").length)showStackError("Внимание","Вы можете загрузить до 10 изображений Вашего объекта. Сейчас загружен максимум.");else{var t,a=o.length;(10<o.length||10<$("#images-preview .advert-preview").length+o.length)&&(a=0<(t=$("#images-preview .advert-preview").length)?10-t:10,showStackError("Внимание","Вы можете загрузить до 10 изображений Вашего объекта. Остальные изображения будут проигнорированы."));for(var n,i=0,s=a;i<s;i++){10<=i||((n={})["ImageForm[files]["+i+"]"]=o[i],r.addFile(n),function(t){var a=new FileReader;a.onloadend=function(e){var r='<div class="advert-preview shadow-box" data-image="ImageForm[files]['+t+']" style="margin-right: 15px; margin-bottom: 15px;"><div class="control"><div class="delete"></div></div><div class="apartment-wrap"><div class="image"><img src="'+a.result+'" alt="" /></div></div></div>';$("#images-preview").append(r)},a.readAsDataURL(o[t])}(i))}}}}),$(document).on("click",".images-preview",function(e){e.preventDefault();var r=$(e.target),t=r.parents(".advert-preview");r.hasClass("index")?$.getJSON("/office/control-image/index/"+t.data("image"),function(e){var r;1==e.status?(t.find(".control .index").remove(),t.addClass("default"),(r=$(".images-preview .advert-preview").not(t)).removeClass("default"),r.find(".index").remove(),r.find(".control").prepend('<div class="index" title="Сделать главным"></div>'),showStackInfo("Информация","Данные сохранены успешно")):showStackError("Ошибка","Возникла критическая ошибка")}):r.hasClass("delete")&&(t.hasClass("loaded")?$.getJSON("/office/control-image/delete/"+t.data("image"),function(e){1==e.status?(t.remove(),showStackInfo("Информация","Данные сохранены успешно")):showStackError("Ошибка","Возникла критическая ошибка")}):($("#form-apartment").data("formApi").removeFile(t.data("image")),t.remove()))}),$(document).on("click",".reservation-send",function(e){e.preventDefault();var r=$(this);$.ajax({url:"/partners/ajax/reservation-confirm",method:"POST",data:{action:"confirm",type:r.data("type"),reservation_id:r.data("reservation"),department:r.data("department"),user_type:r.data("user-type"),user_id:r.data("user-id")},context:document.body}).done(function(e){$("#modal-reservation-confirm").remove(),$("body").append(e),$("#modal-reservation-confirm").modal("show")})}),$("#opendescription").click(function(){$("#information-advert").slideToggle("slow",function(){})}),$(document).on("click","#button-reservation-confirm",function(e){e.preventDefault();var r=$(this);$.ajax({url:"/partners/ajax/reservation-confirm",method:"POST",data:{action:"send",type:r.data("type"),reservation_id:r.data("reservation"),cancel_reason:$("#reservation-confirm-reason").val(),department:r.data("department"),user_type:r.data("user-type"),priced:r.data("priced"),user_id:r.data("user-id")},context:document.body}).done(function(e){var r=$("#reservation-confirm-reason").parents(".form-group");r.removeClass("has-success"),r.removeClass("has-error"),r.find(".help-block").html(""),$.isPlainObject(e)&&"status"in e?1==e.status?($("#modal-reservation-confirm").find(".modal-body").html('<div class="alert alert-info">'+e.message+"</div>"),setTimeout(function(){document.location.reload()},4e3)):showStackError("Ошибка",e.message):$.isArray(e)&&e[0]&&(r.addClass("has-error"),r.find(".help-block").html(e[0]))})}),$(document).on("click","#button-reservation-failure",function(e){e.preventDefault();var r=$(this);$.ajax({url:"/partners/ajax/reservation-failure/"+r.data("id"),method:"GET",context:document.body}).done(function(e){$("#modal-reservation-failure").remove(),$("body").append(e),$("#modal-reservation-failure").modal("show")})}),$(document).on("click","#button-reservation-failure-confirm",function(e){e.preventDefault();var r=$(this);$.ajax({url:"/partners/ajax/reservation-failure/"+r.data("id"),method:"POST",data:{cause_text:$("#reservation-failure-reason").val()},context:document.body}).done(function(e){var r=$("#reservation-failure-reason").parents(".form-group");r.removeClass("has-success"),r.removeClass("has-error"),r.find(".help-block").html(""),$.isPlainObject(e)&&"status"in e?1==e.status?$("#modal-reservation-failure").find(".modal-body").html('<div class="alert alert-info">'+e.message+"</div>"):showStackError("Ошибка",e.message):$.isArray(e)&&e[0]&&(r.addClass("has-error"),r.find(".help-block").html(e[0]))})})});var $preloadFlag=!1;function writeMessage(e){$preloadFlag||($preloadFlag=!0,$.get("/ajax/message/"+e,function(e){$("#modal-message").remove(),$("body").append(e),$("#modal-message").modal("show")}).complete(function(){$preloadFlag=!1}))}$(document).ready(function(){$("#country").on("change","",function(e){"Russia"==$("#country option:selected").text()&&$("#phone").inputmask("+79999999999"),"Ukraine"==$("#country option:selected").text()&&$("#phone").inputmask("+380999999999"),"Belarus"==$("#country option:selected").text()&&$("#phone").inputmask("+375999999999")})});